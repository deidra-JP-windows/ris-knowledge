
# メトリクスの種類と特徴

## Gaugeタイプ

Gaugeタイプのメトリクスは、その時点での値や状態を表現するメトリクスです。
「現在のCPU使用率」「同時接続数」「ディスク空き容量」など、値が上がったり下がったりするものの計測に使われます。
Gaugeは値が増減するどちらのパターンもとれるのが特徴です。

## メトリクスタイプの比較

| メトリクスタイプ | 主な用途 | 特徴 | 例 |
|:---|:---|:---|:---|
| Counter | 積算のみ。増加する値を表現 | マイナスにならない | リクエスト総回数、エラー件数 |
| Gauge | その時点の値。増減がどちらも可能 | 現在値が知りたいとき | CPU使用率、メモリ残量、同時リクエスト数 |
| Histogram | 値の分布、範囲を集計 | バケットで分布、平均/分位数も可能 | レスポンスタイム、リクエストサイズ |
| Summary | 分位数（パーセンタイル）の算出 | クライアント側で分位数算出 | レスポンスタイム等（局所的な分布重視） |

---

## 詳細な比較と特徴

### Gauge
- 現在の状態をそのまま記録（例: 今の温度、今の空きメモリ）
- 増減どちらもあり得る
	- 例: サーバーの同時接続数、現在の残高

### Counter
- 基本的に累積カウント。減らずにリセット時だけゼロに戻る
	- 例: 総HTTPリクエスト数、障害発生回数

### Histogram
- 観測値をあらかじめ決めた区間（バケット）ごとに集計
- 平均や分布状況（例: 何%のリクエストが100ms以内で終わるか）の把握向き

### Summary
- 分位数（p95やp99などのパーセンタイル）を取得するためのメトリクス
- クライアント側で演算されることが多く、グローバル集計が難しい場合も

---

## 選択のポイント
- **増減どちらもする値** → Gauge
- **加算しかない、合計を知りたい** → Counter
- **値の分布（パーセンタイルやヒストグラム的集計）** → Histogram／Summary

それぞれのメトリックタイプを使い分けることで、システムの健全性や問題検知の解像度が高まります。

# コスト

## AWS Cost Explorerで「Refund（払い戻し）」を除外する方法

AWS Cost Explorerで「Refund（払い戻し）」を除外する際のポイントは以下の通りです。

### ポイントまとめ
- 料金タイプ（Charge Type）としてRefund（返金）が存在しますが、「Cost Explorer」の標準UIでは明示的な除外設定ができない場合があります。
- 多くのケースで、Cost Explorerのデフォルト設定では「クレジット」や「払い戻し（Refund）」は既に除外されています。
- もし除外されていない場合、GUIから「Refund」をフィルタで除外することはできませんが、**AWS Budgets**など一部の予算管理ツールでは`IncludeRefund: false`の設定で除外が可能です。

### 具体的な対策
1. **デフォルトで除外済みの可能性が高い**
	- 多くの場合、Cost Explorerの画面でクレジットや払い戻しは基本除外されています。
	- 必要に応じて、自分のCost Explorerで払い戻し額が含まれていないかをレポートの「詳細」や「ダウンロード」機能で明細を確認しましょう。
2. **より細かなコントロールが必要な場合**
	- Budgetsの「追加のコストタイプ」設定（`IncludeRefund`）や、CUR（Cost and Usage Report）を使い、明細レベルで「refund」行を除外して集計する運用も選択肢となります。
3. **Cost Explorer APIやダウンロードデータの利用**
	- APIで明細データを取得し、「record_type」が「Refund」のデータを集計から除外する、といった運用も可能です。

### 補足
- 請求書ビューなどでは返金は含まれませんが、Cost Explorerの一部集計では返金が集計対象になることがあります。

---

## 要約
「Cost Explorer」画面上の標準UIだけでは、払い戻しの除外設定は明確にはできませんが、多くの場合既に除外されています。もし明細上で返金が含まれてしまう場合は、CURやAPI、Budgetsなどの追加機能・ツールを活用して除外運用してください。

