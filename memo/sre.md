
# AWSコスト・メトリクス技術メモ

このドキュメントは、AWSコスト管理やメトリクス設計に関する実践的な知見・注意点をまとめたものです。Cost ExplorerやCUR（Cost and Usage Report）を使ったコスト分析、Athenaクエリの設計、メトリクスの基礎知識など、現場で役立つ情報を体系的に整理しています。

---

## 目次
1. [メトリクスの種類と特徴](#メトリクスの種類と特徴)
2. [AWSコスト管理の実践](#awsコスト管理の実践)
	- [Cost ExplorerでRefundを除外する方法](#cost-explorerでrefundを除外する方法)
	- [CURとCost Explorerの違い・注意点](#curとcost-explorerの違い注意点)
	- [Athenaクエリ設計の注意点](#athenaクエリ設計の注意点)
3. [参考リンク](#参考リンク)

---

# メトリクスの種類と特徴

## Gaugeタイプ

Gaugeタイプのメトリクスは、その時点での値や状態を表現するメトリクスです。
「現在のCPU使用率」「同時接続数」「ディスク空き容量」など、値が上がったり下がったりするものの計測に使われます。
Gaugeは値が増減するどちらのパターンもとれるのが特徴です。

## メトリクスタイプの比較

| メトリクスタイプ | 主な用途 | 特徴 | 例 |
|:---|:---|:---|:---|
| Counter | 積算のみ。増加する値を表現 | マイナスにならない | リクエスト総回数、エラー件数 |
| Gauge | その時点の値。増減がどちらも可能 | 現在値が知りたいとき | CPU使用率、メモリ残量、同時リクエスト数 |
| Histogram | 値の分布、範囲を集計 | バケットで分布、平均/分位数も可能 | レスポンスタイム、リクエストサイズ |
| Summary | 分位数（パーセンタイル）の算出 | クライアント側で分位数算出 | レスポンスタイム等（局所的な分布重視） |

---

## 詳細な比較と特徴

### Gauge
- 現在の状態をそのまま記録（例: 今の温度、今の空きメモリ）
- 増減どちらもあり得る
	- 例: サーバーの同時接続数、現在の残高

### Counter
- 基本的に累積カウント。減らずにリセット時だけゼロに戻る
	- 例: 総HTTPリクエスト数、障害発生回数

### Histogram
- 観測値をあらかじめ決めた区間（バケット）ごとに集計
- 平均や分布状況（例: 何%のリクエストが100ms以内で終わるか）の把握向き

### Summary
- 分位数（p95やp99などのパーセンタイル）を取得するためのメトリクス
- クライアント側で演算されることが多く、グローバル集計が難しい場合も

---

## 選択のポイント
- **増減どちらもする値** → Gauge
- **加算しかない、合計を知りたい** → Counter
- **値の分布（パーセンタイルやヒストグラム的集計）** → Histogram／Summary

それぞれのメトリックタイプを使い分けることで、システムの健全性や問題検知の解像度が高まります。


# AWSコスト管理の実践


## Cost ExplorerでRefund（払い戻し）を除外する方法

AWS Cost Explorerで「Refund（払い戻し）」を除外する際のポイントは以下の通りです。

### ポイントまとめ
- 料金タイプ（Charge Type）としてRefund（返金）が存在しますが、「Cost Explorer」の標準UIでは明示的な除外設定ができない場合があります。
- 多くのケースで、Cost Explorerのデフォルト設定では「クレジット」や「払い戻し（Refund）」は既に除外されています。
- もし除外されていない場合、GUIから「Refund」をフィルタで除外することはできませんが、**AWS Budgets**など一部の予算管理ツールでは`IncludeRefund: false`の設定で除外が可能です。

### 具体的な対策
1. **デフォルトで除外済みの可能性が高い**
	- 多くの場合、Cost Explorerの画面でクレジットや払い戻しは基本除外されています。
	- 必要に応じて、自分のCost Explorerで払い戻し額が含まれていないかをレポートの「詳細」や「ダウンロード」機能で明細を確認しましょう。
2. **より細かなコントロールが必要な場合**
	- Budgetsの「追加のコストタイプ」設定（`IncludeRefund`）や、CUR（Cost and Usage Report）を使い、明細レベルで「refund」行を除外して集計する運用も選択肢となります。
3. **Cost Explorer APIやダウンロードデータの利用**
	- APIで明細データを取得し、「record_type」が「Refund」のデータを集計から除外する、といった運用も可能です。

### 補足
- 請求書ビューなどでは返金は含まれませんが、Cost Explorerの一部集計では返金が集計対象になることがあります。

---


## 要約（Refund除外のポイントまとめ）

「Cost Explorer」画面上の標準UIだけでは、払い戻しの除外設定は明確にはできませんが、多くの場合既に除外されています。もし明細上で返金が含まれてしまう場合は、CURやAPI、Budgetsなどの追加機能・ツールを活用して除外運用してください。

---


## CURとCost Explorerの違い・注意点

1. **集計方式・レベルの違い**  
	- CURは明細行（line item）単位で全てのコストを詳細に記録。Athenaでは自由に集計できるが、Cost Explorerは高次元集計済みデータを想定し、一部のコストをまとめて表示。
	- 割引（RI, Savings Plan）の適用タイミングやRefund, Taxの扱いが異なる場合がある。
2. **コストタイプの誤認識**  
	- Unblended/Blended/Amortizedなど、どのコスト種を集計するかで差異が出る。
	- BlendedCostは組織全体の平均レートのため、単一アカウント集計時に差異が出やすい。
3. **除外条件・フィルタリングの差**  
	- TaxやRefundの除外設定が一致していないと結果が異なる。
	- LineItemTypeやProductCodeでグループ化時、タグの有効化やフィールド名の違いで集計漏れが発生することも。
4. **集計期間・データ更新タイミング**  
	- CURファイルの更新タイミングとCost Explorerの集計“最新情報”に微差が出る場合がある。
5. **クエリのグループ化・タグ設定ミス**  
	- AthenaのGROUP BYやタグ設定がCost Explorerと異なると期待した集計結果にならない。
	- タグはBillingポータル側で有効化し、CURに出る名称（例：environment、スペース→アンダースコア等）にも注意。

---


### 特徴比較

### CUR（Cost and Usage Report）の特徴
- 超詳細な明細データ（サービス単位・リソース単位・カスタムタグ単位でコスト情報が記録）
- CSVやParquet形式で出力、Athena等で任意にクエリ・分析可能
- 生データなので自由なグループ化やフィルタリングが可能
- 精密な課金分析や監査、部門ごとのチャージバック等に向く

### コストエクスプローラー（Cost Explorer）の特徴
- ビジュアルな高次元集計ビュー（グラフやテーブルで可視化）
- 最大18種類のフィルタ・グループ化が可能だが、CURより詳細度は低い
- 利用実績から予測やSavings Plan・RIおすすめ機能も
- 手軽な可視化・クイック分析、全体概要や予算管理、アラート設定に便利

### 主要な違いまとめ表

| 項目 | CUR（Cost and Usage Report） | コストエクスプローラー |
|:---|:---|:---|
| 詳細度 | 超詳細な明細、RAWデータ（CSV等） | 高次元集計ビュー、グラフ・テーブル |
| グループ化の自由 | Athenaで自由にクエリ可能 | 18種のフィルタ・グループが固定 |
| 更新頻度 | 最大1日3回、S3に自動保存 | 毎時・毎日更新 |
| データ用途 | 精密な課金分析、監査、社内課金 | 概要把握、予測、アラート、可視化 |
| 外部連携 | Athena/QuickSight/Tableau等可能 | API/CSV出力（制限あり） |

---


### コスト種別の違い（Unblended/Blended/Amortized）

| コスト種別 | 集計方法/意味 | 分析用途 |
|:---|:---|:---|
| Unblended | 本来の（正規）料金/明細 | 細かな使用コスト分析 |
| Blended | 組織全体の平均料金 | 全体俯瞰・概要把握 |
| Amortized | 前払い割引の均等配分料金 | 最適化、コスト配分分析 |

**どのコスト種を選ぶべきかは、用途（最適化・予算管理・詳細分析など）と割引契約（RI/Savings Plan）の有無で決まります。**

---


### 値が一致しない主なパターンと対策

### 除外条件・フィルタリングの設計違い
- CURは明細行ごとにTaxやRefundなどが混在しやすい。WHERE句で明示的に除外しないと混入する。
- 割引や無料枠、管理費、Credit, RefundなどもGROUP BY時に合計値へ混入しやすい。
- Cost Explorerは割引や返金などを自動的に除外してTOTAL集計するが、フィルタ条件で完全一致とは限らない。

### 対策・ポイント
1. CURで集計ロジックを作るときは、WHEREで`line_item_line_item_type = 'Usage'`など明細タイプを厳密に絞る
2. 本来のリソースコスト以外（Fee, Refund, Tax, Creditなど）は除外する
3. GROUP BY項目ごとに紛れ込みやすい料金タイプ・割引項目を全てチェック
4. コスト種（Amortized, Unblended）、タグの有効化やCURのカラム名・表示タイミングにも注意
5. CoEの画面TOTALと一致させたい場合は請求書とも突合して検算する

---


### 集計期間・データ更新タイミングの違い

### CUR（Cost and Usage Report）
- 通常「1日1回〜最大1日3回」更新、S3バケットにCSVやParquet形式でエクスポート
- 月単位や日単位・時間単位など細かい期間を設定可能
- レポートの更新やS3出力には最大24時間程度のタイムラグがある

### コストエクスプローラー
- 「毎時」または「毎日」データの更新、ほぼリアルタイムに近いコストデータを確認可能
- 月単位、日単位、週単位、任意の日付範囲で集計可能
- 正確な請求額は月末確定まで“暫定値”

### ズレが生じる主な原因
- CURのデータ更新タイミングとCost Explorerの表示値の反映タイミングが異なる
- 月初・月末など期間境界部分や組織アカウント切替時に一時的な差が出やすい
- コスト値を比較する場合は「CURの最新ファイル」と「Cost Explorerの同一期間」を突合し、更新ラグや期間指定・タイムゾーンの違いを確認する

---


## Athenaクエリ設計の注意点

1. **グループ化キーの不一致や粒度の誤り**
	- サービス名はproduct_code、リソース別はresource_id、使用タイプはusage_typeで管理
	- タグの大文字小文字や表記ゆれ（_や-など）に注意
2. **タグの有効化・反映遅延**
	- Billingコンソールでタグ有効化し、CURに反映されるまで最大数日かかる
3. **タグの命名・スキーマ設計不整合**
	- CUR内のタグ名はBillingコンソールの正式名称で出力。現場のタグ名と異なる場合あり
	- スペースや特殊文字の取り扱いにも注意
4. **クエリの構文ミス・ジョインの不備**
	- JOINやGROUP BY不足で重複レコードや不正集計に繋がる
5. **Athenaのクエリ実行環境設定**
	- ワークグループやクエリ結果の保存先設定ミスでエラーや不一致が発生


### まとめ表（Athenaクエリ設計の注意点）

| 項目 | 注意点 |
|:---|:---|
| グルーピングカラムの選定 | 正しいカラム（product_code, usage_type, tag_nameなど）を正規化して使う |
| タグの有効化と反映 | Billing設定でタグ有効化し、CURに反映されるまで待つ |
| タグの命名・表記揺れ | タグ名の一貫性を保ち、表記違いを正規化 |
| クエリ構成の正確性 | 明細に合ったJOIN条件やGROUP BYを使い重複除去 |
| Athena環境設定 | ワークグループ設定やS3出力先を正しく設定 |

---


> これらを適切に管理しないと、サービス別やタグ別に集計した結果が意図しないものになり、コストエクスプローラーや実際の請求額と合わなくなることがよくあります。

---

## 参考リンク
- [AWS Black Belt Online Seminar: Cost and Usage Reports](https://pages.awscloud.com/rs/112-TZM-766/images/AWS-Black-Belt_2023_AWS-CostAndUsageReports_1031_v1.pdf)
