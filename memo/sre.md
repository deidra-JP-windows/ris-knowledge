
# AWSコスト・メトリクス技術メモ

このドキュメントは、AWSコスト管理やメトリクス設計に関する実践的な知見・注意点をまとめたものです。Cost ExplorerやCUR（Cost and Usage Report）を使ったコスト分析、Athenaクエリの設計、メトリクスの基礎知識など、現場で役立つ情報を体系的に整理しています。

---

## 目次
1. [メトリクスの種類と特徴](#メトリクスの種類と特徴)
2. [AWSコスト管理の実践](#awsコスト管理の実践)
	- [Cost ExplorerでRefundを除外する方法](#cost-explorerでrefundを除外する方法)
	- [CURとCost Explorerの違い・注意点](#curとcost-explorerの違い注意点)
	- [Athenaクエリ設計の注意点](#athenaクエリ設計の注意点)
3. [参考リンク](#参考リンク)

---

# メトリクスの種類と特徴

## Gaugeタイプ

Gaugeタイプのメトリクスは、その時点での値や状態を表現するメトリクスです。
「現在のCPU使用率」「同時接続数」「ディスク空き容量」など、値が上がったり下がったりするものの計測に使われます。
Gaugeは値が増減するどちらのパターンもとれるのが特徴です。

## メトリクスタイプの比較

| メトリクスタイプ | 主な用途 | 特徴 | 例 |
|:---|:---|:---|:---|
| Counter | 積算のみ。増加する値を表現 | マイナスにならない | リクエスト総回数、エラー件数 |
| Gauge | その時点の値。増減がどちらも可能 | 現在値が知りたいとき | CPU使用率、メモリ残量、同時リクエスト数 |
| Histogram | 値の分布、範囲を集計 | バケットで分布、平均/分位数も可能 | レスポンスタイム、リクエストサイズ |
| Summary | 分位数（パーセンタイル）の算出 | クライアント側で分位数算出 | レスポンスタイム等（局所的な分布重視） |

---

## 詳細な比較と特徴

### Gauge
- 現在の状態をそのまま記録（例: 今の温度、今の空きメモリ）
- 増減どちらもあり得る
	- 例: サーバーの同時接続数、現在の残高

### Counter
- 基本的に累積カウント。減らずにリセット時だけゼロに戻る
	- 例: 総HTTPリクエスト数、障害発生回数

### Histogram
- 観測値をあらかじめ決めた区間（バケット）ごとに集計
- 平均や分布状況（例: 何%のリクエストが100ms以内で終わるか）の把握向き

### Summary
- 分位数（p95やp99などのパーセンタイル）を取得するためのメトリクス
- クライアント側で演算されることが多く、グローバル集計が難しい場合も

---

## 選択のポイント
- **増減どちらもする値** → Gauge
- **加算しかない、合計を知りたい** → Counter
- **値の分布（パーセンタイルやヒストグラム的集計）** → Histogram／Summary

それぞれのメトリックタイプを使い分けることで、システムの健全性や問題検知の解像度が高まります。


# AWSコスト管理の実践


## Cost ExplorerでRefund（払い戻し）を除外する方法

AWS Cost Explorerで「Refund（払い戻し）」を除外する際のポイントは以下の通りです。

### ポイントまとめ
- 料金タイプ（Charge Type）としてRefund（返金）が存在しますが、「Cost Explorer」の標準UIでは明示的な除外設定ができない場合があります。
- 多くのケースで、Cost Explorerのデフォルト設定では「クレジット」や「払い戻し（Refund）」は既に除外されています。
- もし除外されていない場合、GUIから「Refund」をフィルタで除外することはできませんが、**AWS Budgets**など一部の予算管理ツールでは`IncludeRefund: false`の設定で除外が可能です。

### 具体的な対策
1. **デフォルトで除外済みの可能性が高い**
	- 多くの場合、Cost Explorerの画面でクレジットや払い戻しは基本除外されています。
	- 必要に応じて、自分のCost Explorerで払い戻し額が含まれていないかをレポートの「詳細」や「ダウンロード」機能で明細を確認しましょう。
2. **より細かなコントロールが必要な場合**
	- Budgetsの「追加のコストタイプ」設定（`IncludeRefund`）や、CUR（Cost and Usage Report）を使い、明細レベルで「refund」行を除外して集計する運用も選択肢となります。
3. **Cost Explorer APIやダウンロードデータの利用**
	- APIで明細データを取得し、「record_type」が「Refund」のデータを集計から除外する、といった運用も可能です。

### 補足
- 請求書ビューなどでは返金は含まれませんが、Cost Explorerの一部集計では返金が集計対象になることがあります。

---


## 要約（Refund除外のポイントまとめ）

「Cost Explorer」画面上の標準UIだけでは、払い戻しの除外設定は明確にはできませんが、多くの場合既に除外されています。もし明細上で返金が含まれてしまう場合は、CURやAPI、Budgetsなどの追加機能・ツールを活用して除外運用してください。

---


## CURとCost Explorerの違い・注意点

1. **集計方式・レベルの違い**  
	- CURは明細行（line item）単位で全てのコストを詳細に記録。Athenaでは自由に集計できるが、Cost Explorerは高次元集計済みデータを想定し、一部のコストをまとめて表示。
	- 割引（RI, Savings Plan）の適用タイミングやRefund, Taxの扱いが異なる場合がある。
2. **コストタイプの誤認識**  
	- Unblended/Blended/Amortizedなど、どのコスト種を集計するかで差異が出る。
	- BlendedCostは組織全体の平均レートのため、単一アカウント集計時に差異が出やすい。
3. **除外条件・フィルタリングの差**  
	- TaxやRefundの除外設定が一致していないと結果が異なる。
	- LineItemTypeやProductCodeでグループ化時、タグの有効化やフィールド名の違いで集計漏れが発生することも。
4. **集計期間・データ更新タイミング**  
	- CURファイルの更新タイミングとCost Explorerの集計“最新情報”に微差が出る場合がある。
5. **クエリのグループ化・タグ設定ミス**  
	- AthenaのGROUP BYやタグ設定がCost Explorerと異なると期待した集計結果にならない。
	- タグはBillingポータル側で有効化し、CURに出る名称（例：environment、スペース→アンダースコア等）にも注意。

---


### 特徴比較

### CUR（Cost and Usage Report）の特徴
- 超詳細な明細データ（サービス単位・リソース単位・カスタムタグ単位でコスト情報が記録）
- CSVやParquet形式で出力、Athena等で任意にクエリ・分析可能
- 生データなので自由なグループ化やフィルタリングが可能
- 精密な課金分析や監査、部門ごとのチャージバック等に向く

### コストエクスプローラー（Cost Explorer）の特徴
- ビジュアルな高次元集計ビュー（グラフやテーブルで可視化）
- 最大18種類のフィルタ・グループ化が可能だが、CURより詳細度は低い
- 利用実績から予測やSavings Plan・RIおすすめ機能も
- 手軽な可視化・クイック分析、全体概要や予算管理、アラート設定に便利

### 主要な違いまとめ表

| 項目 | CUR（Cost and Usage Report） | コストエクスプローラー |
|:---|:---|:---|
| 詳細度 | 超詳細な明細、RAWデータ（CSV等） | 高次元集計ビュー、グラフ・テーブル |
| グループ化の自由 | Athenaで自由にクエリ可能 | 18種のフィルタ・グループが固定 |
| 更新頻度 | 最大1日3回、S3に自動保存 | 毎時・毎日更新 |
| データ用途 | 精密な課金分析、監査、社内課金 | 概要把握、予測、アラート、可視化 |
| 外部連携 | Athena/QuickSight/Tableau等可能 | API/CSV出力（制限あり） |

---


### コスト種別の違い（Unblended/Blended/Amortized）

| コスト種別 | 集計方法/意味 | 分析用途 |
|:---|:---|:---|
| Unblended | 本来の（正規）料金/明細 | 細かな使用コスト分析 |
| Blended | 組織全体の平均料金 | 全体俯瞰・概要把握 |
| Amortized | 前払い割引の均等配分料金 | 最適化、コスト配分分析 |

**どのコスト種を選ぶべきかは、用途（最適化・予算管理・詳細分析など）と割引契約（RI/Savings Plan）の有無で決まります。**

---


### 値が一致しない主なパターンと対策

### 除外条件・フィルタリングの設計違い
- CURは明細行ごとにTaxやRefundなどが混在しやすい。WHERE句で明示的に除外しないと混入する。
- 割引や無料枠、管理費、Credit, RefundなどもGROUP BY時に合計値へ混入しやすい。
- Cost Explorerは割引や返金などを自動的に除外してTOTAL集計するが、フィルタ条件で完全一致とは限らない。

### 対策・ポイント
1. CURで集計ロジックを作るときは、WHEREで`line_item_line_item_type = 'Usage'`など明細タイプを厳密に絞る
2. 本来のリソースコスト以外（Fee, Refund, Tax, Creditなど）は除外する
3. GROUP BY項目ごとに紛れ込みやすい料金タイプ・割引項目を全てチェック
4. コスト種（Amortized, Unblended）、タグの有効化やCURのカラム名・表示タイミングにも注意
5. CoEの画面TOTALと一致させたい場合は請求書とも突合して検算する

---


### 集計期間・データ更新タイミングの違い

### CUR（Cost and Usage Report）
- 通常「1日1回〜最大1日3回」更新、S3バケットにCSVやParquet形式でエクスポート
- 月単位や日単位・時間単位など細かい期間を設定可能
- レポートの更新やS3出力には最大24時間程度のタイムラグがある

### コストエクスプローラー
- 「毎時」または「毎日」データの更新、ほぼリアルタイムに近いコストデータを確認可能
- 月単位、日単位、週単位、任意の日付範囲で集計可能
- 正確な請求額は月末確定まで“暫定値”

### ズレが生じる主な原因
- CURのデータ更新タイミングとCost Explorerの表示値の反映タイミングが異なる
- 月初・月末など期間境界部分や組織アカウント切替時に一時的な差が出やすい
- コスト値を比較する場合は「CURの最新ファイル」と「Cost Explorerの同一期間」を突合し、更新ラグや期間指定・タイムゾーンの違いを確認する

---


## Athenaクエリ設計の注意点

1. **グループ化キーの不一致や粒度の誤り**
	- サービス名はproduct_code、リソース別はresource_id、使用タイプはusage_typeで管理
	- タグの大文字小文字や表記ゆれ（_や-など）に注意
2. **タグの有効化・反映遅延**
	- Billingコンソールでタグ有効化し、CURに反映されるまで最大数日かかる
3. **タグの命名・スキーマ設計不整合**
	- CUR内のタグ名はBillingコンソールの正式名称で出力。現場のタグ名と異なる場合あり
	- スペースや特殊文字の取り扱いにも注意
4. **クエリの構文ミス・ジョインの不備**
	- JOINやGROUP BY不足で重複レコードや不正集計に繋がる
5. **Athenaのクエリ実行環境設定**
	- ワークグループやクエリ結果の保存先設定ミスでエラーや不一致が発生


### まとめ表（Athenaクエリ設計の注意点）

| 項目 | 注意点 |
|:---|:---|
| グルーピングカラムの選定 | 正しいカラム（product_code, usage_type, tag_nameなど）を正規化して使う |
| タグの有効化と反映 | Billing設定でタグ有効化し、CURに反映されるまで待つ |
| タグの命名・表記揺れ | タグ名の一貫性を保ち、表記違いを正規化 |
| クエリ構成の正確性 | 明細に合ったJOIN条件やGROUP BYを使い重複除去 |
| Athena環境設定 | ワークグループ設定やS3出力先を正しく設定 |

---


> これらを適切に管理しないと、サービス別やタグ別に集計した結果が意図しないものになり、コストエクスプローラーや実際の請求額と合わなくなることがよくあります。

---

## 参考リンク
- [AWS Black Belt Online Seminar: Cost and Usage Reports](https://pages.awscloud.com/rs/112-TZM-766/images/AWS-Black-Belt_2023_AWS-CostAndUsageReports_1031_v1.pdf)


多層防御（Defense in Depth）とは、サイバー攻撃に対して複数の防御層を設けてリスクを最小化する考え方です。入口・内部・出口の各段階で異なる対策を講じ、1つの防御が破られてもほかの層で阻止や検知が可能となるよう設計されています。主な構成要素としてIDS（侵入検知システム）、IPS（侵入防止システム）、アンチウイルスソフト、ファイアウォールなどがあります。

***

### 多層防御の構成要素

- **ファイアウォール**  
  ネットワークの境界に設置され、不審な通信を遮断する役割。外部からの不正アクセスや攻撃を入口段階で防ぐ基本的な防御層。

- **IDS/IPS（侵入検知・防止システム）**  
  ファイアウォールが通過させた通信の監視を行い、異常な通信や攻撃の兆候を検知（IDS）したり、自動で遮断（IPS）したりする。

- **アンチウイルスソフト**  
  エンドポイント（PCやサーバー）に導入され、マルウェアの検知・駆除を行う。感染や発症の内部拡大を防止。

- **その他の侵入防止技術**  
  VPN、サンドボックス、Webアプリケーションファイアウォール（WAF）、ログ監視、EDR（Endpoint Detection and Response）など、多様な防御手段を重ねて用いる。

***

### 入口・内部・出口の対策分類と役割

| 対策フェーズ | 役割 | 代表的な対策・技術 | 説明 |
|-------------|------|------------------|------|
| **入口対策** | 不正侵入・マルウェアなどの侵入を防ぐ最前線 | ファイアウォール、IDS/IPS、メールフィルタリング、VPN | 外部からの攻撃やマルウェア感染を通信の段階で遮断し、システムへの侵入を阻止。IDSは異常検知を行い、IPSは即時遮断を行う。 |
| **内部対策** | 侵入後の感染拡大・不正活動の検知と防止 | アンチウイルスソフト、ログ監視、EDR、アクセス制御 | 内部ネットワークでのマルウェア感染や横展開を抑制。不審な動きをログで監視し、被害拡大を抑える。 |
| **出口対策** | 内部から外部への情報漏洩や不正通信の遮断 | サンドボックス、WAF、プロキシ、DLP（データ漏洩防止） | 攻撃者が内部の情報を外部へ送信したり、不正な通信を行うのを防止して情報漏洩を防ぐ。 |

***

### 事前対策と事後対策の位置づけ

- **事前対策**  
  侵入防止や感染防止を目的とした「入口対策」と「内部対策」が主に該当します。脆弱性管理やセキュリティソフトによるマルウェア対策などにより、攻撃の発生や拡大を未然に防ぐ。

- **事後対策**  
  万が一の攻撃で侵入や感染があっても、被害を最小化し、迅速に回復するための対応。ログ監視による早期検知、インシデントレスポンス、被害範囲の隔離、バックアップ復旧などが含まれます。

***

### 多層防御のポイントまとめ

- 複数の防御層を設け、一層突破されても次の層で阻止・検知ができる仕組みを作る。
- 入口ではファイアウォールやIDS/IPSで外部攻撃をブロック。
- 内部ではアンチウイルス、EDR、ログ監視で感染や不正活動を早期に検知し防止。
- 出口ではサンドボックスやプロキシで情報漏洩を防ぎ、社内外への不正通信を遮断。
- 事前対策（未然防止）と事後対策（被害最小化・復旧）を統合的に実施。

このような多層的かつ段階的な対策により、サイバー攻撃に対する強固なセキュリティ体制を構築できます。[1][2][3][4][5][6][8][9]

[1](https://www.quest.co.jp/column/defense-in-depth-zero-trust.html)
[2](https://www.cybersolutions.co.jp/product/securitysuite/cmss-blog/24376/)
[3](https://group.gmo/security/cybersecurity/cyberattack/blog/defense-in-depth/)
[4](https://business.ntt-east.co.jp/service/securitypackage/column/defence_in_depth/index.html)
[5](https://cybersecurity-jp.com/column/10554)
[6](https://info.hightech.co.jp/blog/20250729-1)
[7](https://www.netattest.com/multi-layer-defense-2024_mkt_tst)
[8](https://www.iwi.co.jp/blog/security/cybersecurity_measures/20220414-did/)
[9](https://www.ntt.com/business/services/xmanaged/lp/column/defense-in-depth.html)
[10](https://www.ntt.com/bizon/malware-types.html)
シグネチャーベース」は、あらかじめ登録された既知のパターン（シグネチャー）と照合することで、攻撃やマルウェアを検出する方式を指します。情報セキュリティ分野では、特定の攻撃手法やマルウェアの特徴的なデータと一致する通信を検出して脅威を特定する方法を指し、従来のアンチウイルスソフトなどで使われます。﻿
シグネチャーベースの仕組み
1. シグネチャーの登録:
既知のウイルスや攻撃パターンを解析し、特徴的なデータ（コードの断片、ファイル形式、動作パターンなど）を抽出して「シグネチャー」として登録します。﻿
2. 照合:
ネットワーク通信や実行されるファイルが、このシグネチャーデータベースと照合されます。﻿
3. 検知:
登録されているシグネチャーと一致するものが検出された場合、それが既知の攻撃パターンやマルウェアであると判断し、検知またはブロックします。﻿
メリットとデメリット﻿
メリット:
既知の脅威に対しては、高速かつ正確に検知できるというメリットがあります。
デメリット:
新たに出現した未知のマルウェアや、攻撃パターンが異なる「ゼロデイ攻撃」には対応できません。
他の検出方式
振る舞い検知:プログラムの異常な活動や不審な動作を検知して未知の脅威に対応します。﻿
ヒューリスティック検知:既知のマルウェアに似た未知のマルウェアを検出する技術です。﻿
近年では、これらの技術を組み合わせた次世代型アンチウイルス（NGAV）が、より包括的なセキュリティを提供しています。﻿
EDR（Endpoint Detection and Response：エンドポイント検知・対応）は、PCやサーバー、スマートフォンなどのエンドポイントに対する高度なセキュリティ対策技術です。エンドポイント上で発生する挙動や通信、ログなどのデータをリアルタイムで収集・監視し、不審な動作やマルウェアの兆候を検出、分析して迅速に対応することを目的としています。

***

### EDRの主な特徴と機能

- **継続的な監視とデータ収集**  
  エンドポイントのシステムログ、ファイル操作、プロセス実行、ネットワーク通信、ユーザー行動など、多様なデータを常に収集し状況を把握します。

- **脅威検出**  
  シグネチャベースの検出だけでなく、動作解析や機械学習を使った異常検知により、未知のマルウェアやゼロデイ攻撃など従来のウイルス対策では捕捉しにくい攻撃を識別します。

- **迅速な対応**  
  異常を検知した際には、管理者が遠隔で対象の端末をネットワークから隔離したり、悪意あるプロセスの停止、ファイルの隔離・削除などができ、被害の拡大を防ぎます。

- **フォレンジックと調査支援**  
  攻撃の発生源や感染経路、影響範囲を時系列で解析するための詳細なログや証跡を提供し、セキュリティインシデントの原因追及と対策立案に役立ちます。

***

### 従来のアンチウイルスソフト（EPP）との違い

- EPP（Endpoint Protection Platform）は主に既知のマルウェア検出と防御に重点を置くのに対し、  
- EDRは未知の脅威や複雑化する攻撃に対応するため、**検知→分析→対応**までを一連で行える高度な監視・対応機能を備えている点が特徴です。

***

### EDRの導入による利点

- サイバー攻撃の侵入後の被害拡大を早期に検知・封じ込め可能。
- 攻撃の全体像を把握できるため、的確な対応策が立てやすい。
- 高度化・多様化する攻撃手法に対しても柔軟に対応できる。
- ゼロデイ攻撃や標的型攻撃に強い防御力を発揮。

***

このように、EDRは多層防御の「内部対策」や「事後対策」の中核技術として、組織のセキュリティ体制強化に不可欠な存在となっています。[1][2][3][5]

[1](https://biz.kddi.com/content/glossary/e/edr/)
[2](https://www.fujitsu.com/jp/services/infrastructure/network/word/edr/)
[3](https://www.sophos.com/ja-jp/cybersecurity-explained/endpoint-detection-and-response)
[4](https://www.kaspersky.co.jp/resource-center/preemptive-safety/endpoint-detection-and-response)
[5](https://www.cybereason.co.jp/blog/edr/2224/)
[6](https://www.ntt.com/bizon/glossary/e-e/edr.html)
[7](https://www.ntt.com/business/lp/edr.html)
[8](https://www.nec-solutioninnovators.co.jp/ss/insider/security-words/06.html)
[9](https://www.i3-systems.com/column/about-edr)
[10](https://www.nri-secure.co.jp/glossary/edr)
